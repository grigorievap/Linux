# Уменьшение размера диска для образа RedOS 7.3 Murom #
---

## 1. Уменьшаем SWAP до 500 МБ ##

**1.1) Определяем имя LV для подкачки:**
```
lvs
```

**1.2)  Отключаем том подкачки:**
```
swapoff /dev/ro_redos/swap
```

**1.3)  Уменьшаем размер подкачки на 1 GiB:**
```
lvresize -L-1GiB /dev/ro_redos/swap
```

**1.4)  Форматируем раздел подкачки:**
```
mkswap /dev/ro_redos/swap
```

**1.5)  Включаем том подкачки:**
```
swapon /dev/volgroup0/swap_lv1
```

**1.6)  Проверяем новый размер подкачки:**
```
free -h
```

## 2. Уменьшаем SWAP ##

**2.1) Делаем бэкап данных (снапшот)**

**2.2) Загружаемся в rescue mode**
- На экране выбираем "3" для перехода сразу в shell

**2.3) Активируем Logical Volume**
```
vgchange -ay
```

**2.4) Проверяем ФС**
```
e2fsck -f /dev/mapper/rhel-root
```

**2.5) Добавляем к root разделу гиг отрезанный от SWAP (Можно пропустить этот шаг)**
```
lvresize -L+1GiB /dev/ro_redos/root
```

**2.6) Уменьшаем root раздел**
```
resize2fs /dev/mapper/ro_redos-root 4500M
lvreduce -L 4500M /dev/mapper/ro_redos-root
```

**2.7) Просмотр списка сегментов и перенос их в начало**
```
pvs -v --segments /dev/sda2
```
- В случае, если физические экстенты находятся в конце раздела, который мы собираемся уменьшать, то нужно переместить их в начало раздела. 
```
pvmove --alloc anywhere /dev/sda2
```
- Но может не получится, двигаем все в конец, а потом SWAP в начало и все остальное за ним, пример ниже:
```
pvmove --alloc anywhere /dev/sda2:1637-2761 /dev/sda2:128:1252
```

**2.8) Монтируем и проверяем (Шаг можно пропустить)**
```
mount /dev/mapper/rhel-root /mnt/sysimage/
df -h
```

**2.9) Уменьшаем размер тома и группы томов**
```
pvresize -v --setphysicalvolumesize 5100M /dev/sda2
```

## 3. Уменьшение диска ##

- Загружаемся с LiveCD (например десктопная Ubuntu) и через Gpart уменьшаем диск до минимума

## 4. Уменьшение диска на сервере (опционально)##

**4.1) На сервере ProxMox VE**

- Делаем копию диска
```
cp vm-10011-disk-0.qcow2 vm-10011-disk-0.qcow2-bcp
```
- Резайзим диск
```
qemu-img resize vm-10011-disk-0.qcow2 --shrink -9G
```
- Проверяем размер диска
```
qemu-img info vm-10011-disk-0.qcow2
```
- Если диск занимает чуть больше чем виртуальный после ресайза, то клонируем виртуалку а старую удаляем





